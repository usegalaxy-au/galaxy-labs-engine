{% comment %}
  Tool Audit Results Modal
  Displays the results of backend tool availability checking
{% endcomment %}

<div class="text-center mt-5 mb-3">
  <button
    type="button"
    class="btn {% if audit_summary.broken_tools == 0 %}btn-success{% else %}btn-danger{% endif %} btn-lg shadow"
    data-bs-toggle="modal"
    data-bs-target="#auditModal"
    title="Show Audit Results"
  >
    {% if audit_summary.broken_tools == 0 %}
      <i class="fas fa-check-circle me-2"></i>
      Audit success
    {% else %}
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ audit_summary.broken_tools }} issues
    {% endif %}
  </button>
</div>

<div id="auditModal" class="modal fade" tabindex="-1" aria-labelledby="auditModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="auditModalLabel">Audit Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        {% if audit_error %}
          <!-- Show error if audit failed -->
          <div class="alert alert-danger">
            <strong>Audit Error:</strong> {{ audit_error|safe }}
          </div>
        {% else %}
          <!-- Show audit summary -->
          {% if audit_results %}
            <div class="accordion my-3" id="allToolsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="allToolsHeading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#allToolsCollapse" aria-expanded="false" aria-controls="allToolsCollapse">
                    <i class="fas fa-list me-2"></i>
                    <strong>Audit Complete:</strong>
                    {{ audit_summary.working_tools }} of {{ audit_summary.total_tools }} linked Galaxy tools are available.
                    {% if audit_summary.broken_tools > 0 %}
                    {{ audit_summary.broken_tools }} tools are unavailable.
                    {% endif %}
                  </button>
                </h2>
                <div id="allToolsCollapse" class="accordion-collapse collapse" aria-labelledby="allToolsHeading" data-bs-parent="#allToolsAccordion">
                  <div class="accordion-body">
                    <div class="list-group">
                      {% for tool_id, tool in audit_results.items %}
                        <div class="list-group-item {% if not tool.exists %}list-group-item-danger{% else %}list-group-item-success{% endif %}">
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                              <div class="fw-bold">
                                {% if tool.exists %}
                                  <i class="fas fa-check-circle text-success me-2"></i>
                                {% else %}
                                  <i class="fas fa-times-circle text-danger me-2"></i>
                                {% endif %}
                                {{ tool.link_text }}
                              </div>
                              <div class="mt-2">
                                <small class="text-muted"><strong>Tool ID:</strong></small>
                                <code class="ms-1">{{ tool.tool_id }}</code>
                              </div>
                              <div class="mt-1">
                                <small class="text-muted"><strong>URL:</strong></small>
                                <code class="ms-1">{{ tool.url }}</code>
                              </div>
                              {% if tool.error %}
                                <div class="mt-1">
                                  <small class="text-muted"><strong>Error:</strong></small>
                                  <code class="ms-1 text-danger">{{ tool.error }}</code>
                                </div>
                              {% endif %}
                            </div>
                            <span class="badge {% if tool.exists %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                              {% if tool.exists %}Available{% else %}Unavailable{% endif %}
                            </span>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="alert {% if audit_summary.broken_tools == 0 %}alert-success{% else %}alert-warning{% endif %}">
              <strong>Audit Complete:</strong>
              {{ audit_summary.working_tools }} of {{ audit_summary.total_tools }} linked Galaxy tools are available.
              {% if audit_summary.broken_tools > 0 %}
              {{ audit_summary.broken_tools }} tools are unavailable.
              {% endif %}
            </div>
          {% endif %}

          {% if audit_summary.total_tools == 0 %}
            <!-- No tools found -->
            <p class="text-info">No Galaxy tool links found on this page.</p>
            
          {% elif audit_summary.broken_tools == 0 %}
            <!-- All tools working -->
            <p class="text-success">âœ“ All tools are available on the Galaxy server!</p>
            
          {% else %}
            <p class="lead">
              The following tools could not be fetched. After checking that these tool IDs are correct, you may wish to request installation of these tools on the target Galaxy server, or
              <a href="/#section_1-faq-7-accordion">exclude them</a>
              from this Galaxy Lab.
            </p>

            <p class="alert alert-info">
              Tabs and content items which contain a broken tool link have been highlighted in
              <span class="font-danger">red</span>
              in the Lab webpage.
            </p>

            <ul class="list-group">
              {% for tool_id, tool in audit_results.items %}
                {% if not tool.exists %}
                  <li class="list-group-item list-group-item-danger">
                    <table class="table">
                      <tr>
                        <td><strong class="text-nowrap">Tool ID</strong></td>
                        <td><code>{{ tool.tool_id }}</code></td>
                      </tr>
                      <tr>
                        <td><strong class="text-nowrap">URL</strong></td>
                        <td><code>{{ tool.url }}</code></td>
                      </tr>
                      <tr>
                        <td><strong class="text-nowrap">Error</strong></td>
                        <td><code>{{ tool.error }}</code></td>
                      </tr>
                    </table>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          {% endif %}

        {% endif %}
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% load static %}

<script>
// Set broken tool URLs for the external audit.js script
{% if audit_results %}
window.auditBrokenToolUrls = [
  {% for tool_id, tool in audit_results.items %}
    {% if not tool.exists %}
      "{{ tool.url|escapejs }}",
    {% endif %}
  {% endfor %}
];
{% else %}
window.auditBrokenToolUrls = [];
{% endif %}
</script>

<script src="{% static 'labs/js/audit.js' %}"></script>
