{% extends 'labs/header.html' %}
{% load static %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link rel="stylesheet" href="{% static 'reporting/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-sm">
    <div class="card-body p-4">
      <h1 class="mb-2">Galaxy Labs Usage Dashboard</h1>
      <div class="text-muted mb-4">
        View lab visits and tool usage metrics over time
        {% if visit_range.min_date and visit_range.max_date %}
        <br>
        <strong>Lab Visits data:</strong>
        {{ visit_range.min_date|date:"d/m/Y" }}
        - {{ visit_range.max_date|date:"d/m/Y" }}
        {% endif %}
        {% if tool_range.min_date and tool_range.max_date %}
        <br>
        <strong>Tool Usage data:</strong>
        {{ tool_range.min_date|date:"d/m/Y" }}
        - {{ tool_range.max_date|date:"d/m/Y" }}
        {% endif %}
      </div>

      <div class="d-flex gap-3 mb-4 flex-wrap align-items-end">
        <div>
          <label for="metric-select" class="form-label">Metric:</label>
          <select id="metric-select" class="form-select">
            <option value="visits">Lab Visits</option>
            <option value="tools">Tool Usage</option>
          </select>
        </div>

        <div id="lab-filter-group" style="display: none">
          <label for="lab-filter" class="form-label">Lab:</label>
          <select id="lab-filter" class="form-select" style="min-width: 200px">
            <option value="all">All Labs</option>
            {% for lab in labs %}
            <option value="{{ lab }}">{{ lab }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="tool-filter-group" style="display: none">
          <label for="tool-filter" class="form-label">Tool:</label>
          <select id="tool-filter" class="form-select" style="min-width: 200px">
            <option value="all">All</option>
          </select>
        </div>
      </div>

      <p class="mb-2">Date range:</p>
      <div class="d-flex gap-3 mb-4 flex-wrap align-items-end">
        <div class="date-range-buttons btn-group" role="group">
          <button type="button" data-days="90" class="btn btn-primary date-btn active">
            3 Mo
          </button>
          <button type="button" data-days="180" class="btn btn-outline-primary date-btn">
            6 Mo
          </button>
          <button type="button" data-days="365" class="btn btn-outline-primary date-btn">
            12 Mo
          </button>
        </div>

        <div class="custom-date-range">
          <input type="date" id="start-date" class="form-control" />
          <input type="date" id="end-date" class="form-control" />
          <button id="apply-custom-range" class="btn btn-primary">Apply</button>
        </div>

        <div class="ms-auto">
          <button id="download-csv" class="btn btn-success">
            <i class="fas fa-download me-1"></i>Download CSV
          </button>
        </div>
      </div>

      <div id="chart" class="mt-4"></div>

      <div id="loading" class="text-center py-5 text-muted" style="display: none">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>

        <p class="mt-3">Loading data...</p>
      </div>

      <div id="nodata" class="lead my-5" style="display: none">
        <p class="mb-3">
          No records to display. Please upload some data to see usage metrics:
        </p>

        <p>
          <small>
            To create an API key, please visit
            <a href="https://{{ request.get_host }}/admin">the admin panel</a>
          </small>
        </p>

        <pre class="bg-light p-3 rounded"><code>curl -X POST \
    -F file=@/path/to/your/nginx/logfile.log \
    -F "log_type=[nginx_welcome / nginx_tool]" \
    -H "X-API-KEY: YOUR_API_KEY" \
    https://{{ request.get_host }}/api/labs/upload-logs</code></pre>
      </div>

      <div id="error" class="alert alert-danger" style="display: none"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'reporting/js/dashboard.js' %}"></script>
{% endblock %}
